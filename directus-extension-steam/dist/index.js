import e from"crypto";import t from"https";var r,a=(e,t,r=500)=>class extends Error{name="DirectusError";extensions;code=e.toUpperCase();status=r;constructor(e,r){super("string"==typeof t?t:t(e),r),this.extensions=e}toString(){return`${this.name} [${this.code}]: ${this.message}`}},n={};var o=(r||(r=1,function(r){const a=e;function n(e){return"string"==typeof e?e.match(/[0-9a-f]{40}/i)?Buffer.from(e,"hex"):Buffer.from(e,"base64"):e}r.time=function(e){return Math.floor(Date.now()/1e3)+(e||0)},r.generateAuthCode=r.getAuthCode=function(e,t){if("function"==typeof t)return void r.getTimeOffset((a,n,o)=>{if(a)return void t(a);let s=r.generateAuthCode(e,n);t(null,s,n,o)});e=n(e);let o=r.time(t),s=Buffer.allocUnsafe(8);s.writeUInt32BE(0,0),s.writeUInt32BE(Math.floor(o/30),4);let i=a.createHmac("sha1",e);i=i.update(s).digest();let c=15&i[19];i=i.slice(c,c+4);let u=2147483647&i.readUInt32BE(0);const f="23456789BCDFGHJKMNPQRTVWXY";let d="";for(let e=0;e<5;e++)d+=f.charAt(u%26),u/=26;return d},r.generateConfirmationKey=r.getConfirmationKey=function(e,t,r){e=n(e);let o=8;r&&(r.length>32?o+=32:o+=r.length);let s=Buffer.allocUnsafe(o);return s.writeBigUInt64BE?s.writeBigUInt64BE(BigInt(t),0):(s.writeUInt32BE(0,0),s.writeUInt32BE(t,4)),r&&s.write(r,8),a.createHmac("sha1",e).update(s).digest("base64")},r.getTimeOffset=function(e){let a=Date.now(),n=t.request({hostname:"api.steampowered.com",path:"/ITwoFactorService/QueryTime/v1/",method:"POST",headers:{"Content-Length":0}},t=>{if(200!=t.statusCode)return void e(new Error("HTTP error "+t.statusCode));let n="";t.on("data",e=>{n+=e}),t.on("end",()=>{try{n=JSON.parse(n).response}catch(t){e(new Error("Malformed response"))}n&&n.server_time||e(new Error("Malformed response"));let t=Date.now(),o=n.server_time-r.time();e(null,o,t-a)})});n.on("error",e),n.end()},r.getDeviceID=function(e){let t=process.env.STEAM_TOTP_SALT||"";return"android:"+a.createHash("sha1").update(e.toString()+t).digest("hex").replace(/^([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12}).*$/,"$1-$2-$3-$4-$5")}}(n)),n);async function s(e,t){const r=new t.services.ItemsService("Steam_Account",{knex:t.database,accountability:null,schema:await t.getSchema({database:t.database})}),n=await r.readOne(e);if(!n)throw a("NOT_FOUND","Account not found");const s=new t.services.AssetsService({knex:t.database,accountability:null,schema:await t.getSchema({database:t.database})}),i=await s.getAsset(n.sda_file),c=(await async function(e){const t=[];for await(const r of e)t.push(r);return Buffer.concat(t)}(i.stream)).toString("utf-8"),u=JSON.parse(c);return o.generateAuthCode(u.shared_secret)}var i={id:"steam",handler:(e,t)=>{e.get("/code",(e,r)=>async function(e,t,r){var a=t.query.username;const n=await s(a,e);r.send({code:n})}(t,e,r)),e.get("/code/batch",(e,r)=>async function(e,t,r){const a=t.query.username;if(!Array.isArray(a))return r.status(400).send({error:"Invalid request"});const n=await Promise.all(a.map(t=>s(t,e).then(e=>({[t]:e}))));r.send({codes:n})}(t,e,r))}};export{i as default};
